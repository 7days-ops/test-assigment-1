---
- name: Install OpenSSL for certificate generation
  apt:
    name: openssl
    state: present
    update_cache: true


- name: Create Nginx directories on host
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  loop:
    - /opt/nginx/conf
    - /opt/nginx/ssl
    - /opt/nginx/cache
    - /opt/nginx/logs

- name: Check if SSL certificate exists
  stat:
    path: /opt/nginx/ssl/server.crt
  register: ssl_cert_stat

- name: Generate self-signed SSL certificate
  command: >
    openssl req -x509 -nodes -days 365 -newkey rsa:2048
    -keyout /opt/nginx/ssl/server.key
    -out /opt/nginx/ssl/server.crt
    -subj "/C=BY/ST=Minsk/L=Minsk/O=DevOps/CN={{ nginx_server_name }}"
  when: not ssl_cert_stat.stat.exists

- name: Set SSL certificate permissions
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0600'
  loop:
    - /opt/nginx/ssl/server.crt
    - /opt/nginx/ssl/server.key

- name: Create Nginx configuration from template
  template:
    src: nginx.conf.j2
    dest: /opt/nginx/conf/nginx.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: Create site configuration from template
  template:
    src: site.conf.j2
    dest: /opt/nginx/conf/default.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart nginx

- name: Pull nginx image
  community.docker.docker_image:
    name: nginx:alpine
    source: pull

- name: Run Nginx container
  community.docker.docker_container:
    name: nginx
    image: nginx:alpine
    state: started
    restart_policy: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /opt/nginx/conf/nginx.conf:/etc/nginx/nginx.conf:ro
      - /opt/nginx/conf/default.conf:/etc/nginx/conf.d/default.conf:ro
      - /opt/nginx/ssl:/etc/nginx/ssl:ro
      - /opt/nginx/cache:/var/cache/nginx
      - /opt/nginx/logs:/var/log/nginx
  notify: restart nginx

